#!/usr/bin/env bash

docker node ls 2>&1 >/dev/null || {
    read -p "Enable swarm mode in Docker? [Y/n] " answer
    [[ -z ${answer} ]] && answer='y'
    [[ ${answer} =~ [yY] ]] && { docker swarm init; } || { exit 1; }
}

[[ -z $(docker secret ls -q) ]] && {
    read -p "No secrets found in Docker's vault. Create dummy secrets? [Y/n] " answer
    [[ -z ${answer} ]] && answer='y'
    [[ ${answer} =~ [yY] ]] && { utils/create-dummy-secrets; } || { exit 1; }
}

[[ -z $(docker config ls -qf name=pipeline-jobs) ]] && {
    read -p "Configuration 'pipeline-jobs' not found in Docker. Create config with job for this project? [Y/n] " answer
    [[ -z ${answer} ]] && answer='y'
    [[ ${answer} =~ [yY] ]] && { utils/create-jobs-config; } || { exit 1; }
}

[[ -z $(docker config ls -qf name=pipeline-config) ]] && {
    read -p "Configuration 'pipeline-config' not found in Docker. Create dummy config? [Y/n] " answer
    [[ -z ${answer} ]] && answer='y'
    [[ ${answer} =~ [yY] ]] && { utils/create-config; } || { exit 1; }
}

mvn package || exit 1
docker/build-images local || exit 1
stackFile="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/stack.yml"
REGISTRY=local VERSION=latest docker stack deploy --prune --resolve-image never -c ${stackFile} pipeline
