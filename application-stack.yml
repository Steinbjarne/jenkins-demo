version: '3.2'

services:
  jenkins:
    image: docker-registry.dmz.local/eid-jenkins:${VERSION}
    ports:
      - "80:8080"
    environment:
      DOCKER_HOST:
      REPOSITORIES: >
        eid;git@git.difi.local:eid;git_difi;
        jenkins-docker;git@github.com:difi/jenkins-docker;git_difi;
        kontaktregister-statistikk;https://github.com/difi/kontaktregister-statistikk;;
        poc-statistics;https://github.com/difi/poc-statistics;;
        eid-oidc-provider;git@git.difi.local:eid-oidc-provider;git_difi;
        minid-on-the-fly;git@git.difi.local:minid-on-the-fly;git_difi;
        eid-resilience;git@git.difi.local:eid-common-resilience.git;git_difi;
        eid-common;git@git.difi.local:eid-common.git;git_difi;
        krr;git@git.difi.local:krr.git;git_difi;
        idporten;git@git.difi.local:idporten.git;git_difi;
        idporten-admin;git@git.difi.local:idporten-admin.git;git_difi;
        idporten-authlevel;git@git.difi.local:idporten-authlevel.git;git_difi;
        idporten-app-dpi-reklame;git@git.difi.local:idporten-app-dpi-reklame.git;git_difi;
        idporten-minid-updater;git@git.difi.local:idporten-minid-updater.git;git_difi;
        idporten-pinkoder;git@git.difi.local:idporten-pinkoder.git;git_difi;
        dine-kontaktopplysninger;git@git.difi.local:dine-kontaktopplysninger.git;git_difi;
        dsf-gateway;git@git.difi.local:dsf-gateway.git;git_difi;
        eid-level1-poc;git@git.difi.local:eid-level1-poc.git;git_difi;
        eid-system-tests;git@git.difi.local:eid-system-tests.git;git_difi;
        eid-pipeline-branch;git@git.difi.local:eid-pipeline-branch.git;git_difi;
        eid-pipeline;git@git.difi.local:eid-pipeline.git;git_difi;
      KNOWN_HOSTS: |
        github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
        git.difi.local ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBG4VYlrX7IlRq+O1lokYTp1oYe7vsIPAmm9uhDec2TVvCkPnSeNhJq9iCyRYCaaCxZLRfUjQdCNc6NvNyXdZb6k=
        eid-gitlab.dmz.local ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEApaqpEGnJ/z4Ur+bgHhnpYCBCdyPuDMVxUplgVPaUTjCLEiEioU+LgZsr04pX6s9sqHbH+0+ggAizxpXQZJ4AOgyeSCwtZNpqX3jXdXMCXqjQgDY/Pxu1vi91PucNK8B4lwkrhed9Ze8iCzdKY5w1NZDpB6Auc+UL2I0HJNDIlrxenYXdqtK6udLyEv1eViGCOIPY1YJ1SjVxMWv2G4itdJDQrOqe6U3p5Ph3P810rtIh/q4Z1PbdS98Jvh3VewdMpQjqPSTskn+EsnlEGJf8vvJmsVsRol1X5bmU/mxIXsaySzPmKdH34hQFzdejdjp83FYRffV0OYhL8Ur9ZU+Apw==
        eid-jenkins02.dmz.local ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBC1UgDT1mm3EJ2w90x2zeEVzxdFPxcqkp+a0N6+0WLgNgTLVFRt2/hSM48VfCaFQaOzVw8PfxVSIHtuunFry1qo=
      uid: '${uid}'
      gid: '${gid}'
    deploy:
      placement:
        constraints:
          - node.role == manager
    secrets:
      - source: git_difi
        target: git_difi
        mode: 0400
        uid: '${uid}'
        gid: '${gid}'
      - source: github
        target: github
        mode: 0400
        uid: '${uid}'
        gid: '${gid}'
      - source: artifactory-cleaner
        target: artifactory-cleaner
        mode: 0400
        uid: '${uid}'
        gid: '${gid}'
      - source: crucible_username
        target: crucible_username
        mode: 0400
        uid: '${uid}'
        gid: '${gid}'
      - source: crucible_password
        target: crucible_password
        mode: 0400
        uid: '${uid}'
        gid: '${gid}'
    volumes:
      - type: bind
        source: ${SSH_AUTH_SOCK}
        target: /ssh_auth_sock
      - type: bind
        source: ${HOME}/data
        target: /var/jenkins_home
      - type: bind
        source: ${HOME}/.docker
        target: /var/jenkins_home/.docker
      - type: bind
        source: ${HOME}/.m2
        target: /var/jenkins_home/.m2
      - type: bind
        source: ${HOME}/.aws
        target: /var/jenkins_home/.aws
    networks:
      - pipeline
  nexus:
    image: sonatype/nexus3:3.3.2
    ports:
      - "8080:8081"
    networks:
      - pipeline
  selenium_host:
    image: selenium/standalone-firefox:2.53.0
    ports:
      - "4444:4444"
    networks:
      - pipeline

networks:
  pipeline:
    driver: overlay
    attachable: true

secrets:
  git_difi:
    external: true
  github:
    external: true
  artifactory-cleaner:
    external: true
  crucible_username:
    external: true
  crucible_password:
    external: true
